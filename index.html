<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Live PSI Indicator</title>

    <!-- Pulling JQuery from Google API -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Pulling fonts from Google Fonts -->
    <!-- TODO: Host fonts locally to avoid EU GDPR fine -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata&family=Libre+Franklin:wght@600&display=swap" rel="stylesheet"> 
    
    <!-- CSS -->
    <style>
        body {
            /*Gruvbox-Light colors*/
            --bg0: #fbf1c7;
            --bg1: #ebdbb2;
            --bg2: #d5c4a1;
            --bg3: #bdae93;
            --bg4: #a89984;
            --fg0: #282828;
            --fg1: #3c3836;
            --fg2: #504945;
            --fg3: #665c54;
            --fg4: #7c6f64;
            --red: #cc241d;
            --org: #d65d0e;
            --ylw: #d79921;
            --grn: #98971a;
            --blu: #458588;
            --prp: #b16286;
            --aqa: #689d6a;
            --gry: #7c6f64;
            --red_d: #9d0006;
            --org_d: #af3a03;
            --ylw_d: #b57614;
            --grn_d: #79740e;
            --blu_d: #076678;
            --prp_d: #8f3f71;
            --aqa_d: #427b58;
            --gry_d: #928374;

            background: var(--bg0);
            color: var(--fg0);
            font-family: 'Inconsolata', 'Courier New', monospace;
            font-size: 1em;
            text-align: center;

        }

        h1 {
            font-family: 'Libre Franklin';
            font-weight: bold;
        }

        a:link {
            color: var(--org);
            text-decoration: none;
        }

        a:visited {
            color: var(--org_d);
        }

        table {
            border-collapse: collapse;
            font: inherit;
            width: 50vw;
            margin: auto;
            max-width: 600px;
        }

        td, th {
            text-align: center;
            padding: 0.5em 1em 0.5em;
            min-width: 4.5em;
            white-space: nowrap;
        }

        th {
            text-transform: capitalize;
        }

        tr:nth-child(even) {
            background-color: var(--bg2);
        }

        tr:nth-child(odd) {
            background-color: var(--bg1);
        }

        tr:nth-child(1) {
            background-color: var(--fg1);
            color: var(--bg0);
        }

    </style>
</head>

<body>

    <h1>Live PSI update</h1>
    <p><span id="timestamp"></span></p>
    <table id="psi_table"></table>
    <p><i>Source: </i><a href="https://data.gov.sg/dataset/psi" target="_blank">Pollutant Standards Index (PSI) - data.gov.sg</a></p>
    <!-- TODO: add an update button -->

    <script>
        let raw_data = {};
        let readings = {};
        let timestamp = "";
        let psi_data = "";

        // hardcoding desired order of columns and rows
        // as well as row definitions
        // TODO: is there a better way to do this??
        let rows = {
            psi_twenty_four_hourly: "PSI (24h)",
            pm10_twenty_four_hourly: "PM10 (24h)",
            pm10_sub_index: "PM10 (sub-index)",
            pm25_twenty_four_hourly: "PM25 (24h)",
            pm25_sub_index: "PM25 (sub-index)",
            so2_twenty_four_hourly: "SO<sub>2</sub> (24h)",
            so2_sub_index: "SO<sub>2</sub> (sub-index)",
            co_eight_hour_max: "CO (8h)",
            co_sub_index: "CO (sub-index)",
            no2_one_hour_max: "NO<sub>2</sub> (1h)",
            o3_eight_hour_max: "O<sub>3</sub> (8h)",
            o3_sub_index: "O<sub>3</sub> (sub-index)"
        };
        let columns = ["central","north","south","east","west","national"];

        async function fetchdata() {
            let response = await fetch('https://api.data.gov.sg/v1/environment/psi');
            let data = await response.json();
            return data;
        }

        fetchdata().then(data => {
            
            raw_data = data;
            readings = raw_data["items"][0]["readings"];
            
            // Append timestamp
            timestamp += "<i>Last updated: </i>";
            timestamp += Date(raw_data["items"][0]["timestamp"]);
            $("#timestamp").append(timestamp);            

            // Append locations
            psi_data += "<tr><th>Readings</th>";
            $.each(columns, function(index, region) {
                psi_data += "<th>"+region+"</th>";
            });
            psi_data += "</tr>";

            // Append readings
            // - column order follows hardcoded 'columns' object
            // - rows order follows hardcoded 'rows' array
            $.each(rows, function(key,value){
                psi_data += "<tr><td>"+value+"</td>";
                // function(index,region) is used to avoid confusion with parent loop
                $.each(columns, function(index, region) {
                    psi_data += "<td>"+readings[key][region]+"</td>";
                });
                psi_data += "</tr>"
            });
            
            // Write to the table
            $("#psi_table").append(psi_data);

            // TODO: Further colouring based on pollutant level?
        });
    </script>

</body>

</html>